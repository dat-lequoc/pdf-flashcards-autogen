<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer with Flashcard Generation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --background-color: #ecf0f1;
            --text-color: #34495e;
            --highlight-color: #e74c3c;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        #top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: rgba(52, 152, 219, 0.4); /* More transparent background */
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px); /* Add blur effect for better readability */
        }

        #file-input {
            color: transparent;
        }

        #file-input::before {
            content: 'Choose PDF';
            display: inline-block;
            background: var(--secondary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        #page-navigation {
            display: flex;
            align-items: center;
        }

        #current-page {
            margin-right: 15px;
            font-weight: bold;
        }

        #page-input {
            width: 60px;
            margin-right: 10px;
            padding: 5px;
            border: none;
            border-radius: 3px;
        }

        #go-to-page-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #go-to-page-btn:hover {
            background-color: #34495e;
        }

        #left-panel {
            flex-grow: 1;
            width: 75%;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
            height: 100vh;
        }

        #right-panel {
            width: 25%;
            height: 100vh;
            position: fixed;
            right: 0;
            top: 0;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            background-color: white;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
        }

        #file-input,
        #mode-toggle,
        #top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        #settings-icon {
            cursor: pointer;
            font-size: 24px;
        }

        #page-navigation {
            display: flex;
            align-items: center;
        }

        #page-input {
            width: 60px;
            margin-right: 10px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        #go-to-page-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #go-to-page-btn:hover {
            background-color: #34495e;
        }

        #settings-panel {
            margin-top: 15px;
        }

        #api-key-input,
        #model-select {
            margin-bottom: 15px;
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        #pdf-viewer {
            border: 1px solid #ddd;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .page {
            position: relative;
            margin-bottom: 20px;
        }

        .text-layer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            opacity: 0.2;
            line-height: 1.0;
        }

        .text-layer > span {
            color: transparent;
            position: absolute;
            white-space: pre;
            cursor: text;
            transform-origin: 0% 0%;
        }

        ::selection {
            background: rgba(52, 152, 219, 0.3);
        }

        .highlight {
            background-color: var(--highlight-color);
            mix-blend-mode: multiply;
        }

        #system-prompt, #explain-prompt {
            width: 100%;
            height: 150px;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            resize: vertical;
        }

        #explain-prompt {
            display: none;
        }

        #submit-btn {
            width: 100%;
            margin-bottom: 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #submit-btn:hover {
            background-color: #2980b9;
        }

        #flashcards {
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 15px;
            background-color: white;
            border-radius: 3px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .flashcard {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 3px;
            transition: box-shadow 0.3s ease;
            font-size: 1.1em; /* Increase font size for flashcards */
        }

        .flashcard:hover {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .remove-btn {
            float: right;
            background-color: var(--highlight-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .remove-btn:hover {
            background-color: #c0392b;
        }

        #recent-pdfs {
            margin-top: 20px;
        }

        #recent-pdfs h3 {
            margin-bottom: 10px;
            color: var(--secondary-color);
        }

        #recent-pdfs ul {
            padding-left: 20px;
            list-style-type: none;
        }

        #recent-pdfs li {
            margin-bottom: 5px;
        }

        #recent-pdfs a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        #recent-pdfs a:hover {
            color: #2980b9;
        }

        #add-to-collection-btn,
        #clear-collection-btn,
        #export-csv-btn {
            width: 100%;
            margin-bottom: 10px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #add-to-collection-btn:hover,
        #clear-collection-btn:hover,
        #export-csv-btn:hover {
            background-color: #34495e;
        }
    </style>
</head>

<body>
    <div id="top-bar">
        <input type="file" id="file-input">
        <span id="current-page">Page: 1</span>
    </div>
    <div id="left-panel">
        <div id="pdf-viewer"></div>
    </div>
    <div id="right-panel">
        <div id="top-controls">
            <div id="settings-icon">⚙️</div>
            <div id="page-navigation">
                <input type="number" id="page-input" min="1" placeholder="Go to page">
                <button id="go-to-page-btn">Go</button>
            </div>
        </div>
        <div id="settings-panel" style="display: none;">
            <input type="password" id="api-key-input" placeholder="Enter Claude API Key">
            <select id="model-select">
                <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                <option value="claude-3-5-sonnet-20240620">Claude 3 Sonnet</option>
            </select>
            <textarea id="system-prompt" placeholder="Enter system prompt for flashcard generation">Generate concise flashcards based on the following text. The number of flashcards should be proportional to the text's length and complexity, with a minimum of 1 and a maximum of 10. Each flashcard should have a question (Q:) that tests a key concept and an answer (A:) that is brief but complete. Ensure that the flashcards cover different aspects of the text when possible. Use <b> tags to emphasize important words or phrases in both questions and answers.

Example:
Text: "The mitochondrion is often described as the powerhouse of the cell because it generates most of the cell's supply of adenosine triphosphate (ATP), used as a source of chemical energy. Mitochondria are found in nearly all eukaryotic organisms and vary in number and location according to cell type."

Q: What is the <b>primary function</b> of mitochondria in cells?
A: To generate <b>ATP</b>, the main source of <b>cellular energy</b>.
Q: In which <b>types of organisms</b> are mitochondria typically found?
A: In nearly all <b>eukaryotic organisms</b>.
Q: How do mitochondria <b>vary</b> among different cell types?
A: They vary in <b>number and location</b> according to the <b>cell type</b>.

Now generate flashcards for this text:</textarea>
            <textarea id="explain-prompt" placeholder="Enter system prompt for explanation" style="display: none;">Explain the following text in simple terms, focusing on the main concepts and their relationships. Use clear and concise language, and break down complex ideas into easily understandable parts. If there are any technical terms, provide brief explanations for them.

Explanation:</textarea>
        </div>
        <select id="mode-toggle">
            <option value="flashcard">Flashcard Mode</option>
            <option value="highlight">Highlight Mode</option>
            <option value="explain">Explain Mode</option>
        </select>
        <button id="submit-btn">Generate</button>
        <div id="flashcards"></div>
        <div id="collection">
            <button id="add-to-collection-btn">Add to Collection (0)</button>
            <button id="clear-collection-btn">Clear Collection</button>
        </div>
        <button id="export-csv-btn" style="display: none;">Export Flashcards to CSV</button>
        <div id="recent-pdfs">
            <h3>Recent PDFs</h3>
            <ul id="pdf-list"></ul>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js';

        const fileInput = document.getElementById('file-input');
        const pdfViewer = document.getElementById('pdf-viewer');
        const modeToggle = document.getElementById('mode-toggle');
        const systemPrompt = document.getElementById('system-prompt');
        const submitBtn = document.getElementById('submit-btn');
        const flashcardsContainer = document.getElementById('flashcards');
        const apiKeyInput = document.getElementById('api-key-input');
        const modelSelect = document.getElementById('model-select');
        const recentPdfList = document.getElementById('recent-pdf-list');

        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 3;
        let mode = 'flashcard';
        let apiKey = '';
        let currentFileName = '';
        let currentPage = 1;
        let selectedModel = 'claude-3-haiku-20240307';

        function renderPage(num) {
            pageRendering = true;
            pdfDoc.getPage(num).then(function (page) {
                const viewport = page.getViewport({ scale: scale });
                const pixelRatio = window.devicePixelRatio || 1;
                const adjustedViewport = page.getViewport({ scale: scale * pixelRatio });

                const pageDiv = document.createElement('div');
                pageDiv.className = 'page';
                pageDiv.dataset.pageNumber = num;
                pageDiv.style.width = `${viewport.width}px`;
                pageDiv.style.height = `${viewport.height}px`;

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.height = adjustedViewport.height;
                canvas.width = adjustedViewport.width;
                canvas.style.width = `${viewport.width}px`;
                canvas.style.height = `${viewport.height}px`;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: adjustedViewport,
                    enableWebGL: true,
                    renderInteractiveForms: true,
                };

                const renderTask = page.render(renderContext);

                renderTask.promise.then(function () {
                    pageRendering = false;
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });

                pageDiv.appendChild(canvas);

                // Text layer
                const textLayerDiv = document.createElement('div');
                textLayerDiv.className = 'text-layer';
                textLayerDiv.style.width = `${viewport.width}px`;
                textLayerDiv.style.height = `${viewport.height}px`;
                pageDiv.appendChild(textLayerDiv);

                page.getTextContent().then(function (textContent) {
                    pdfjsLib.renderTextLayer({
                        textContent: textContent,
                        container: textLayerDiv,
                        viewport: viewport,
                        textDivs: []
                    });
                });

                pdfViewer.appendChild(pageDiv);

                // Check if we need to load more pages
                if (num < pdfDoc.numPages && pdfViewer.scrollHeight <= window.innerHeight * 2) {
                    renderPage(num + 1);
                }
            });
        }

        function loadPDF(file) {
            const fileReader = new FileReader();
            fileReader.onload = function () {
                const typedarray = new Uint8Array(this.result);

                pdfjsLib.getDocument(typedarray).promise.then(function (pdf) {
                    pdfDoc = pdf;
                    pdfViewer.innerHTML = '';
                    currentFileName = file.name;
                    const lastPage = localStorage.getItem(`lastPage_${currentFileName}`);
                    pageNum = lastPage ? parseInt(lastPage) : 1;
                    renderPage(pageNum);
                    updateCurrentPage(pageNum);
                    hideHeaderPanel();
                });
            };
            fileReader.readAsArrayBuffer(file);
        }

        function hideHeaderPanel() {
            document.getElementById('top-bar').style.display = 'none';
        }

        function goToPage(num) {
            if (num >= 1 && num <= pdfDoc.numPages) {
                pageNum = num;
                pdfViewer.innerHTML = '';
                renderPage(pageNum);
                updateCurrentPage(pageNum);
                localStorage.setItem(`lastPage_${currentFileName}`, pageNum);
            } else {
                alert('Invalid page number');
            }
        }

        function updateCurrentPage(num) {
            if (num !== currentPage) {
                currentPage = num;
                document.getElementById('current-page').textContent = `Page: ${num}`;
                document.getElementById('page-input').value = num;
                localStorage.setItem(`lastPage_${currentFileName}`, num);
            }
        }

        // Infinite scrolling with page tracking
        document.getElementById('left-panel').addEventListener('scroll', function () {
            if (this.scrollTop + this.clientHeight >= this.scrollHeight - 500) {
                if (pageNum < pdfDoc.numPages) {
                    pageNum++;
                    renderPage(pageNum);
                }
            }

            // Update current page based on scroll position
            const pages = document.querySelectorAll('.page');
            for (let i = 0; i < pages.length; i++) {
                const page = pages[i];
                const rect = page.getBoundingClientRect();
                if (rect.top >= 0 && rect.bottom <= window.innerHeight) {
                    const newPageNum = parseInt(page.dataset.pageNumber);
                    updateCurrentPage(newPageNum);
                    break;
                }
            }
        });

        function highlight(event) {
            if (mode !== 'highlight') return;

            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const highlightSpan = document.createElement('span');
                highlightSpan.className = 'highlight';

                if (range.commonAncestorContainer.closest('.text-layer')) {
                    try {
                        range.surroundContents(highlightSpan);
                    } catch (e) {
                        console.error("Highlighting failed:", e);
                        const textNodes = getTextNodesInRange(range);
                        textNodes.forEach(node => {
                            const nodeRange = document.createRange();
                            nodeRange.selectNodeContents(node);
                            nodeRange.surroundContents(highlightSpan.cloneNode(true));
                        });
                    }
                }
            }
            selection.removeAllRanges();
        }

        function getTextNodesInRange(range) {
            const textNodes = [];
            const treeWalker = document.createTreeWalker(
                range.commonAncestorContainer,
                NodeFilter.SHOW_TEXT,
                { acceptNode: node => range.intersectsNode(node) ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT }
            );
            while (treeWalker.nextNode()) {
                textNodes.push(treeWalker.currentNode);
            }
            return textNodes;
        }

        async function generateContent() {
            if (!apiKey) {
                alert('Please enter your Claude API key first.');
                return;
            }

            const selection = window.getSelection();
            if (selection.rangeCount > 0 && selection.toString().trim() !== '') {
                const selectedText = selection.toString();
                let prompt;
                
                if (mode === 'flashcard') {
                    prompt = `${systemPrompt.value}\n\n${selectedText}`;
                } else if (mode === 'explain') {
                    prompt = `${document.getElementById('explain-prompt').value}\n\n${selectedText}`;
                } else {
                    return;
                }

                try {
                    const response = await callClaudeAPI(prompt);
                    if (mode === 'flashcard' && response.flashcards) {
                        displayFlashcards(response.flashcards, true);
                    } else if (mode === 'explain' && response.explanation) {
                        displayExplanation(response.explanation);
                    } else {
                        throw new Error('Invalid response from API');
                    }
                } catch (error) {
                    console.error('Error calling Claude API:', error);
                    alert(`Failed to generate ${mode === 'flashcard' ? 'flashcards' : 'explanation'}. Please check your API key and try again.`);
                }
            } else {
                alert(`Please select some text from the PDF to generate ${mode === 'flashcard' ? 'flashcards' : 'an explanation'}.`);
            }
        }

        function displayExplanation(explanation) {
            flashcardsContainer.innerHTML = ''; // Clear existing content
            const explanationElement = document.createElement('div');
            explanationElement.className = 'explanation';
            explanationElement.innerHTML = `
                <h3>Explanation</h3>
                <p>${explanation}</p>
                <button class="remove-btn">Remove</button>
            `;
            explanationElement.querySelector('.remove-btn').addEventListener('click', function () {
                explanationElement.remove();
            });
            flashcardsContainer.appendChild(explanationElement);
        }

        async function callClaudeAPI(prompt) {
            const response = await fetch('/generate_flashcard', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': apiKey
                },
                body: JSON.stringify({ 
                    prompt: prompt,
                    model: selectedModel
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
        }

        modelSelect.addEventListener('change', function () {
            selectedModel = this.value;
        });

        function displayFlashcards(flashcards, append = false) {
            if (!append) {
                flashcardsContainer.innerHTML = ''; // Clear existing flashcards only if not appending
            }
            flashcards.forEach(flashcard => {
                const flashcardElement = document.createElement('div');
                flashcardElement.className = 'flashcard';
                flashcardElement.innerHTML = `
                    <strong>Q: ${flashcard.question}</strong><br>
                    A: ${flashcard.answer}
                    <button class="remove-btn">Remove</button>
                `;
                flashcardElement.querySelector('.remove-btn').addEventListener('click', function () {
                    flashcardElement.remove();
                    updateExportButtonVisibility();
                });
                flashcardsContainer.appendChild(flashcardElement);
            });
            updateExportButtonVisibility();
        }

        let collectionCount = 0;
        let collectedFlashcards = [];

        function addToCollection() {
            const newFlashcards = Array.from(document.querySelectorAll('.flashcard:not(.in-collection)')).map(flashcard => {
                const question = flashcard.querySelector('strong').textContent.slice(3);
                const answer = flashcard.innerHTML.split('<br>')[1].split('<button')[0].trim().slice(3);
                return { question, answer };
            });
            
            collectedFlashcards = collectedFlashcards.concat(newFlashcards);
            updateCollectionCount(newFlashcards.length);
            clearDisplayedFlashcards();
            updateExportButtonVisibility();
        }

        function clearDisplayedFlashcards() {
            flashcardsContainer.innerHTML = '';
        }

        function updateCollectionCount(change) {
            collectionCount += change;
            const addToCollectionBtn = document.getElementById('add-to-collection-btn');
            addToCollectionBtn.textContent = `Add to Collection (${collectionCount})`;
            localStorage.setItem('collectionCount', collectionCount);
            localStorage.setItem('collectedFlashcards', JSON.stringify(collectedFlashcards));
        }

        // Initialize collection count and flashcards from localStorage
        collectionCount = parseInt(localStorage.getItem('collectionCount')) || 0;
        collectedFlashcards = JSON.parse(localStorage.getItem('collectedFlashcards')) || [];
        document.getElementById('add-to-collection-btn').textContent = `Add to Collection (${collectionCount})`;

        document.getElementById('add-to-collection-btn').addEventListener('click', addToCollection);

        function updateExportButtonVisibility() {
            const exportButton = document.getElementById('export-csv-btn');
            exportButton.style.display = collectedFlashcards.length > 0 ? 'block' : 'none';
        }

        function exportToCSV() {
            <!-- No header needed for csv -->
            let csvContent = "data:text/csv;charset=utf-8,";

            collectedFlashcards.forEach(flashcard => {
                csvContent += `"${flashcard.question}","${flashcard.answer}"\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "flashcards.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);

        function clearCollection() {
            if (confirm('Are you sure you want to clear the entire collection? This action cannot be undone.')) {
                collectedFlashcards = [];
                collectionCount = 0;
                updateCollectionCount(0);
                updateExportButtonVisibility();
                localStorage.removeItem('collectedFlashcards');
                localStorage.removeItem('collectionCount');
            }
        }

        document.getElementById('clear-collection-btn').addEventListener('click', clearCollection);

        // Initialize export button visibility
        updateExportButtonVisibility();

        function addRecentPDF(filename) {
            let recentPDFs = JSON.parse(localStorage.getItem('recentPDFs')) || [];
            recentPDFs = recentPDFs.filter(pdf => pdf.filename !== filename);
            recentPDFs.unshift({ filename: filename, date: new Date().toISOString() });
            recentPDFs = recentPDFs.slice(0, 5);  // Keep only the 5 most recent
            localStorage.setItem('recentPDFs', JSON.stringify(recentPDFs));
            updateRecentPDFsList();
        }

        function updateRecentPDFsList() {
            const recentPDFs = JSON.parse(localStorage.getItem('recentPDFs')) || [];
            recentPdfList.innerHTML = '';
            recentPDFs.forEach(pdf => {
                const li = document.createElement('li');
                li.textContent = `${pdf.filename} (${new Date(pdf.date).toLocaleDateString()})`;
                recentPdfList.appendChild(li);
            });
        }

        fileInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file.type !== 'application/pdf') {
                console.error('Error: Not a PDF file');
                return;
            }
            loadPDF(file);
            addRecentPDF(file.name);
            this.nextElementSibling.textContent = file.name;
        });

        // Add a span next to the file input to display the selected file name
        const fileNameDisplay = document.createElement('span');
        fileNameDisplay.style.marginLeft = '10px';
        fileInput.parentNode.insertBefore(fileNameDisplay, fileInput.nextSibling);

        document.getElementById('go-to-page-btn').addEventListener('click', function() {
            const pageInput = document.getElementById('page-input');
            const pageNumber = parseInt(pageInput.value);
            goToPage(pageNumber);
        });

        modeToggle.addEventListener('change', function () {
            mode = this.value;
            pdfViewer.style.cursor = mode === 'highlight' ? 'crosshair' : 'default';
            systemPrompt.style.display = mode === 'flashcard' ? 'block' : 'none';
            explainPrompt.style.display = mode === 'explain' ? 'block' : 'none';
            submitBtn.textContent = mode === 'flashcard' ? 'Generate Flashcards' : 'Generate Explanation';
        });

        pdfViewer.addEventListener('mouseup', highlight);

        submitBtn.addEventListener('click', generateContent);

        apiKeyInput.addEventListener('change', function () {
            apiKey = this.value;
            localStorage.setItem('lastWorkingAPIKey', apiKey);
        });

        // Load last working API key
        const lastWorkingAPIKey = localStorage.getItem('lastWorkingAPIKey');
        if (lastWorkingAPIKey) {
            apiKeyInput.value = lastWorkingAPIKey;
            apiKey = lastWorkingAPIKey;
        }

        // Infinite scrolling
        document.getElementById('left-panel').addEventListener('scroll', function () {
            if (this.scrollTop + this.clientHeight >= this.scrollHeight - 500) {
                if (pageNum < pdfDoc.numPages) {
                    pageNum++;
                    renderPage(pageNum);
                }
            }
        });

        function loadRecentPDFs() {
            const recentPDFs = {{ recent_pdfs|tojson }};
            const pdfList = document.getElementById('pdf-list');
            pdfList.innerHTML = '';
            recentPDFs.forEach(pdf => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = `${pdf.filename} (${new Date(pdf.date).toLocaleDateString()})`;
                a.addEventListener('click', function(e) {
                    e.preventDefault();
                    fetch(`/open_pdf/${pdf.filename}`)
                        .then(response => response.blob())
                        .then(blob => {
                            const file = new File([blob], pdf.filename, { type: 'application/pdf' });
                            loadPDF(file);
                        })
                        .catch(error => console.error('Error:', error));
                });
                li.appendChild(a);
                pdfList.appendChild(li);
            });
        }

        // Save current page before unloading
        window.addEventListener('beforeunload', function() {
            if (currentFileName) {
                localStorage.setItem(`lastPage_${currentFileName}`, pageNum);
            }
        });

        // Initialize recent PDFs list
        window.onload = function() {
            loadRecentPDFs();
            
            // Add event listener for settings icon
            document.getElementById('settings-icon').addEventListener('click', function() {
                const settingsPanel = document.getElementById('settings-panel');
                settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block' : 'none';
            });
        };

        fileInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file.type !== 'application/pdf') {
                console.error('Error: Not a PDF file');
                return;
            }
            uploadPDF(file);
        });

        function uploadPDF(file) {
            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload_pdf', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    console.log(data.message);
                    loadPDF(file);
                    loadRecentPDFs();
                } else {
                    console.error(data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    </script>
</body>

</html>
